<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>LeizerGraph Viewer</title>

    <meta property="og:title" content="LeizerGraph">
    <meta property="og:description" content="">
    <meta property="og:type" content="img">
    <meta property="og:url" content="LeizerGraph">
    <meta property="og:image" content="https://cdn-images.dzcdn.net/images/cover/0f1c81210af1d4270fc7531249e61707/0x1900-000000-80-0-0.jpg">

    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 40px auto;
            padding: 0;
            background: #121212;
            color: #e0e0e0;
            line-height: 1.8;
            overflow: auto;
        }
        img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 20px auto;
            cursor: pointer;
        }
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease;
            overflow: hidden;
        }
        .lightbox img {
            max-width: 100%;
            max-height: 100%;
        }
        .lightbox.show {
            visibility: visible;
            opacity: 1;
        }
        .img-wrapper {
            position: relative;
            max-width: 100%;
            max-height: 100%;
        }
        .img-wrapper img {
            display: block;
            max-width: 100vw;
            max-height: 100vh;
            height: auto;
            width: auto;
            margin: 0 auto;
        }
        .img-wrapper .counter {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.3);
            padding: 3px 4px;
            line-height: 1.1;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            z-index: 10;
        }
        a.button-link {
            display: inline-block;
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            color: #e0e0e0;
            text-decoration: none;
            border-radius: 0;
            margin: 5px 0;
            font-size: 16px;
            text-align: center;
        }
        a.button-link:hover {
            background-color: #fff;
            color: #000;
        }

        /* Оверлеи для навигации */
        .overlay-left, .overlay-right {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 25%;
            z-index: 5;
            cursor: pointer;
        }
        .overlay-left {
            left: 0;
        }
        .overlay-right {
            right: 0;
        }

        /* Стили для заголовка статьи */
        .article-header {
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        .article-header h1 {
            font-size: 28px;
            margin: 0 0 10px 0;
            color: #fff;
        }
        .article-header address {
            font-style: normal;
            color: #aaa;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .article-header address a {
            color: #aaa;
            text-decoration: none;
        }
        .article-header address a:hover {
            color: #fff;
            text-decoration: underline;
        }
        .article-header address time {
            color: #777;
        }
        .slideshow-btn {
            background: transparent;
            border: 2px solid #e0e0e0;
            color: #e0e0e0;
            padding: 5px 15px;
            cursor: pointer;
            font-size: 14px;
            border-radius: 4px;
            margin-left: 15px;
        }
        .slideshow-btn:hover {
            background-color: #fff;
            color: #000;
        }

        /* Стили для формы ввода */
        .url-input-container {
            text-align: center;
            margin-top: 100px;
        }
        .url-input {
            padding: 12px 15px;
            width: 70%;
            max-width: 500px;
            border: 2px solid #e0e0e0;
            background: transparent;
            color: #e0e0e0;
            font-size: 16px;
            margin-right: 10px;
        }
        .url-submit {
            padding: 12px 25px;
            background: transparent;
            border: 2px solid #e0e0e0;
            color: #e0e0e0;
            font-size: 16px;
            cursor: pointer;
        }
        .url-submit:hover {
            background-color: #fff;
            color: #000;
        }
        .instructions {
            margin-top: 20px;
            color: #aaa;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="content">
        <div class="url-input-container">
            <h2>Telegraph Viewer</h2>
            <input type="text" class="url-input" id="telegraph-url" placeholder="Введите URL статьи Telegraph (например: https://telegra.ph/example)">
            <button class="url-submit" id="show-article">Show</button>
            <div class="instructions">
                Введите полный URL статьи Telegraph или только её часть после telegra.ph/<br>
                Например: "example-url" или "https://telegra.ph/example-url"
            </div>
        </div>
    </div>

    <div class="lightbox" id="lightbox">
        <div class="img-wrapper">
            <img id="lightbox-img" src="" alt="" data-index="0">
            <div class="counter" id="counter"></div>
            <div class="overlay-left"></div>
            <div class="overlay-right"></div>
        </div>
    </div>

    <!-- Юридическое уведомление -->
    <footer style="margin-top: 60px; text-align: center; font-size: 12px; color: #777;">
        <p>
            Этот сайт не хранит и не распространяет материалы, размещённые на платформе Telegraph.<br>
            Все статьи обрабатываются динамически по введённой пользователем ссылке исключительно в информационных целях.
        </p>
    </footer>

    <script>
        let startX = 0, startY = 0;
        let slideshowInterval = null;
        let isSlideshowActive = false;

        function updateMetaTags(title, description, imageUrl, pageUrl) {
            const setMeta = (property, content) => {
                let tag = document.querySelector(`meta[property='${property}']`);
                if (!tag) {
                    tag = document.createElement('meta');
                    tag.setAttribute('property', property);
                    document.head.appendChild(tag);
                }
                tag.setAttribute('content', content);
            };

            setMeta('og:title', title);
            setMeta('og:description', description);
            setMeta('og:type', 'article');
            setMeta('og:url', pageUrl);
            setMeta('og:image', imageUrl);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            return `${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
        }

        function removeDuplicateHeader(articleContent, headerInfo) {
            if (!articleContent) return '';

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = articleContent;
            const children = Array.from(tempDiv.children);

            if (children.length > 0) {
                const firstChild = children[0];

                if (firstChild.tagName === 'H1' && firstChild.textContent.trim() === headerInfo?.title?.trim()) {
                    firstChild.remove();
                }

                if (children.length > 1) {
                    const secondChild = children[1];
                    const headerAuthorLink = headerInfo?.authorLink?.match(/href="([^"]*)"/)?.[1] || '';
                    const articleAuthorLink = secondChild.querySelector('a')?.getAttribute('href') || '';

                    if (secondChild.tagName === 'ADDRESS' && headerAuthorLink === articleAuthorLink) {
                        secondChild.remove();
                    }
                }
            }

            return tempDiv.innerHTML;
        }

        function startSlideshow() {
            if (isSlideshowActive) {
                stopSlideshow();
                return;
            }

            const images = Array.from(document.querySelectorAll("#content img"));
            if (images.length === 0) return;

            // Открываем первое изображение
            openLightbox(0);
            isSlideshowActive = true;
            document.querySelector('.slideshow-btn').textContent = 'Stop Slideshow';

            // Запускаем интервал для смены изображений каждые 8 секунд
            slideshowInterval = setInterval(() => {
                const currentIndex = parseInt(document.getElementById("lightbox-img").dataset.index);
                const nextIndex = (currentIndex + 1) % images.length;
                openLightbox(nextIndex);
            }, 6000);
        }

        function stopSlideshow() {
            if (slideshowInterval) {
                clearInterval(slideshowInterval);
                slideshowInterval = null;
            }
            isSlideshowActive = false;
            if (document.querySelector('.slideshow-btn')) {
                document.querySelector('.slideshow-btn').textContent = 'Slideshow';
            }
        }

        function loadArticle(slug) {
            if (!slug) {
                document.getElementById("content").innerHTML = `
                    <div class="url-input-container">
                        <h2>Telegraph Article Viewer</h2>
                        <input type="text" class="url-input" id="telegraph-url" placeholder="Введите URL статьи Telegraph (например: https://telegra.ph/example)">
                        <button class="url-submit" id="show-article">Show</button>
                        <div class="instructions">
                            Введите полный URL статьи Telegraph или только её часть после telegra.ph/<br>
                            Например: "example-url" или "https://telegra.ph/example-url"
                        </div>
                    </div>
                `;
                document.getElementById('telegraph-url').focus();
                document.getElementById('show-article').addEventListener('click', handleUrlSubmit);
                document.getElementById('telegraph-url').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') handleUrlSubmit();
                });
                return;
            }

            const pageUrl = `https://telegra.ph/${slug}`;
            const url = `https://cors.eu.org/${pageUrl}`;

            fetch(url)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, "text/html");
                    const article = doc.querySelector("article");
                    const header = doc.querySelector(".tl_article_header");

                    if (article || header) {
                        let contentHTML = '';
                        let headerInfo = {};

                        // Обрабатываем заголовок статьи
                        if (header) {
                            const title = header.querySelector("h1")?.textContent || "";
                            const authorLink = header.querySelector("address a")?.outerHTML || "";
                            const authorHref = header.querySelector("address a")?.getAttribute('href') || "";
                            const timeElement = header.querySelector("time");
                            let date = '';

                            headerInfo = {
                                title: title,
                                authorLink: authorLink,
                                authorHref: authorHref
                            };

                            if (timeElement) {
                                const datetime = timeElement.getAttribute("datetime");
                                date = datetime
                                    ? `<time>${formatDate(datetime)}</time>`
                                    : timeElement.outerHTML;
                            }

                            contentHTML += `
                                <div class="article-header">
                                    <div>
                                        <h1>${title}</h1>
                                        <address>${authorLink} ${date}</address>
                                    </div>
                                    <button class="slideshow-btn">Slideshow</button>
                                </div>
                            `;
                        }

                        if (article) {
                            const cleanedContent = removeDuplicateHeader(article.innerHTML, headerInfo);
                            contentHTML += cleanedContent;
                        }

                        document.getElementById("content").innerHTML = contentHTML;
                        setupImageClick();
                        setupLinks();

                        // Добавляем обработчик для кнопки слайдшоу
                        document.querySelector('.slideshow-btn')?.addEventListener('click', startSlideshow);

                        // Обновляем мета-теги
                        const metaTitle = doc.querySelector("title")?.textContent || "Telegraph Article";
                        const metaDescription = article?.textContent.trim().split("\n")[0].slice(0, 150) || "";
                        const metaImage = article?.querySelector("img")?.src || "";
                        updateMetaTags(metaTitle, metaDescription, metaImage, window.location.href);
                    } else {
                        document.getElementById("content").innerHTML = `
                            <div class="url-input-container">
                                <h2>Статья не найдена</h2>
                                <input type="text" class="url-input" id="telegraph-url" placeholder="Введите URL статьи Telegraph (например: https://telegra.ph/example)">
                                <button class="url-submit" id="show-article">Show</button>
                                <div class="instructions">
                                    Введите полный URL статьи Telegraph или только её часть после telegra.ph/<br>
                                    Например: "example-url" или "https://telegra.ph/example-url"
                                </div>
                            </div>
                        `;
                        document.getElementById('telegraph-url').focus();
                        document.getElementById('show-article').addEventListener('click', handleUrlSubmit);
                        document.getElementById('telegraph-url').addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') handleUrlSubmit();
                        });
                    }
                })
                .catch(error => {
                    console.error("Ошибка загрузки:", error);
                    document.getElementById("content").innerHTML = `
                        <div class="url-input-container">
                            <h2>Ошибка загрузки статьи</h2>
                            <input type="text" class="url-input" id="telegraph-url" placeholder="Введите URL статьи Telegraph (например: https://telegra.ph/example)">
                            <button class="url-submit" id="show-article">Show</button>
                            <div class="instructions">
                                Введите полный URL статьи Telegraph или только её часть после telegra.ph/<br>
                                Например: "example-url" или "https://telegra.ph/example-url"
                            </div>
                        </div>
                    `;
                    document.getElementById('telegraph-url').focus();
                    document.getElementById('show-article').addEventListener('click', handleUrlSubmit);
                    document.getElementById('telegraph-url').addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') handleUrlSubmit();
                    });
                });
        }

        function handleUrlSubmit() {
            const input = document.getElementById('telegraph-url').value.trim();
            let slug = '';

            if (input.startsWith('http')) {
                const url = new URL(input);
                slug = url.pathname.replace(/^\//, '').split('/')[0];
            } else {
                slug = input.split('/')[0];
            }

            if (slug) {
                window.history.pushState({}, '', `?${slug}`);
                loadArticle(slug);
            }
        }

        function setupImageClick() {
            let images = Array.from(document.querySelectorAll("#content img"));
            images.forEach((img, index) => {
                img.dataset.index = index;
                img.addEventListener("click", function(event) {
                    event.stopPropagation();
                    openLightbox(index);
                });
            });
        }

        function setupLinks() {
            const paragraphs = document.querySelectorAll('#content p');
            paragraphs.forEach(p => {
                const links = p.querySelectorAll('a');
                links.forEach(link => {
                    link.classList.add("button-link");
                });
            });
        }

        function openLightbox(index) {
            let images = Array.from(document.querySelectorAll("#content img"));
            const lightboxImg = document.getElementById("lightbox-img");
            lightboxImg.src = images[index].src;
            lightboxImg.dataset.index = index;
            document.getElementById("counter").innerText = `${index + 1} / ${images.length}`;
            document.getElementById("lightbox").classList.add("show");
            images[index].scrollIntoView({ behavior: "smooth", block: "center" });
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(() => {});
            }
            document.body.style.overflow = "hidden";
        }

        function closeLightbox() {
            document.getElementById("lightbox").classList.remove("show");
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }
            document.body.style.overflow = "auto";
            stopSlideshow();
        }

        function changeImage(direction) {
            let images = Array.from(document.querySelectorAll("#content img"));
            let currentIndex = parseInt(document.getElementById("lightbox-img").dataset.index);
            if ((direction === -1 && currentIndex > 0) || (direction === 1 && currentIndex < images.length - 1)) {
                openLightbox(currentIndex + direction);
            }
        }

        // Обработчики событий
        document.getElementById("lightbox").addEventListener("click", function(e) {
            if (e.target.id === "lightbox") closeLightbox();
        });

        document.addEventListener("keydown", function(e) {
            if (e.key === "Escape") closeLightbox();
            if (e.key === "ArrowLeft") changeImage(-1);
            if (e.key === "ArrowRight") changeImage(1);
        });

        document.getElementById("lightbox").addEventListener("touchstart", function(e) {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
        });

        document.getElementById("lightbox").addEventListener("touchend", function(e) {
            let endX = e.changedTouches[0].clientX;
            let endY = e.changedTouches[0].clientY;
            let diffX = endX - startX;
            let diffY = endY - startY;

            if (Math.abs(diffX) > Math.abs(diffY)) {
                if (diffX > 50) {
                    changeImage(-1);
                } else if (diffX < -50) {
                    changeImage(1);
                }
            } else {
                if (diffY < -50) {
                    closeLightbox();
                }
            }
        });

        document.getElementById("lightbox").addEventListener("wheel", function(e) {
            if (e.deltaY > 0) {
                changeImage(1);
            } else {
                changeImage(-1);
            }
        });

        document.querySelector(".overlay-left").addEventListener("click", function(e) {
            e.stopPropagation();
            changeImage(-1);
        });

        document.querySelector(".overlay-right").addEventListener("click", function(e) {
            e.stopPropagation();
            changeImage(1);
        });

        // Инициализация при загрузке страницы
        document.addEventListener("DOMContentLoaded", function () {
            let slug = window.location.search.replace("?", "").trim();
            loadArticle(slug);

            document.getElementById('show-article')?.addEventListener('click', handleUrlSubmit);
            document.getElementById('telegraph-url')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleUrlSubmit();
            });
        });
    </script>
</body>
</html>
